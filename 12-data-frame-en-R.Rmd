# DATA FRAME: CREACIÓN, SELECCIÓN, FILTROS, AGREGACIÓN Y TRANSFORMACIÓN DE DATOS.

En este capítulo se tratará sobre la creación de uno de los objetos más importantes en R, los data frames. Asimismo, se mostrará cómo crearlos a través de vectores, cómo seleccionar entre columnas, cómo filtrar entre filas, agregar columnas y filas al data frame; y por último, transformar datos con R base. Esto nos servirá como introducción fundamental para el siguiente capítulo en donde se trabajará con distintos tipos de archivos como: xlsx, xls, sav, dta, txt, csv, entre otros. 

## Creación de data frames.

Un data frame es un objeto que compila uno o más vectores con el fin de tener una estructura compacta y ordenada. En palabras sencillas, será tu tabla de datos en donde tendrás agrupado tus variables que te permitirán desarrollar modelos, gráficos, etc.

La sintaxis del data frame es la siguiente:

`data.frame(..., row.names = NULL, stringsAsFactors = FALSE, ...)`

Donde:  

`...` = En este argumento se asignarán las columnas o variables que tendrá el data frame.  
`row.names` = Este argumento permite asignar los nombres de las filas, por defecto es `NULL` lo cual implica que las filas no tendrán nombres, sino una numeración consecutiva.  
`stringsAsFactors` = Argumento lógico que si toma el valor de `TRUE` convertirá en factores a las variables que son caracter. Su valor por defecto es `FALSE`, por lo que las variables caracter seguirán siendo caracter.  
`...` = Los tres puntos al final de la función nos permite asignar otros argumentos que puede encontrar en la documentación `?data.frame`.

Como primer ejemplo vamos a crear un data frame de 4 columnas. 

```{r}
# Crear un data frame.
set.seed(2021)
df<-data.frame(edad=sample(10:30, 10, T), 
               sexo=sample(c("Masculino","Femenino"), 10, T),
               ingresos=sample(1000:5000, 10, T),
               raza=sample(c("blanco","negro"), 10, T))
```

Y veamos como queda un data frame. 

```{r}
# Viendo el data frame.
df
```

El resultado que obtenemos es un data frame de 4 columnas y 10 filas. Pero ¿Cómo se hizo? Primero, hemos asignado una semilla `set.seed(2021)` porque vamos a crear vectores con elementos aleatorios. Luego, creamos el objeto `df` que tiene 4 columnas: `edad`, `sexo`, `ingresos` y `raza` todos tienen elementos aleatorios.

Es importante darse cuenta que para asignar objetos usamos `<-` pero para asignar columnas dentro de la función `data.frame()` estamos usando `=`. Aquí un ejemplo de cuando usar `<-` y cuando `=`.

Si usted desea ver los resultados en una pestaña y no en la consola, entonces, usted corre:

```{r, eval=FALSE}
# Para ver el data frame en una pestaña.
View(df)
```
<center>
![Vista del data frame](F:/R_para_economistas/img/dataframe.jpg)
</center>

Para ver la estructura de las columnas o variables, se usa la función `str()`.

```{r}
str(df)
```

Nos dice que las variables `edad` e `ingresos` son variables de tipo entero y las variables `sexo` y `raza` son variables de tipo caracter. Recuerde que el valor por defecto de `stringsAsFactors` es `FALSE`, por lo que las variables caracater se mantienen como caracter, si cambiamos el valor del argumento por `TRUE` entonces las variables caracter se convertirían en factor.

Ahora vamos a crear un data frame similar que nos servirá como ejemplo para los siguientes ejemplos. 

```{r}
set.seed(2021)
df<-data.frame(edad=sample(10:30, 30, T), 
               sexo=sample(c("Masculino","Femenino"), 30, T),
               ingresos=sample(1000:5000, 30, T),
               raza=sample(c("blanco","negro"), 30, T),
               material_casa=sample(c("noble","rustica"), 30, T),
               experiencia=sample(0:15,30,T),
               num_hijos=sample(0:4, 30, T))
```

Viendo el data frame que hemos creado.

```{r}
df
```

En este caso nuestro data frame tiene 7 columnas y 30 filas. Imagínese un data frame con más filas y con más columnas, al querer verlo se mostrará una gran cantidad de datos, lo que no es recomendable, solo nos bastaría con ver un pequeño subconjunto del data frame. Entonces si queremos ver las primeras 6 filas de un data frame, se usará la función `head()`.

```{r}
# Viendo las 6 primeras filas. 
head(df)
```

Pero quizá desee ver una cantidad mayor o menor de filas. Para esto se usa la misma función pero especificando el número de filas en el argumento `n` de la función `head()`.

```{r}
# Viendo las 3 primeras filas.
head(df, n=3)

# Viendo las 10 primeras filas.
head(df, n=10)
```

Quizá usted desee ver las 6 últimas filas, entonces, se usará la función `tail()`.

```{r}
# Viendo las últimas 6 filas.
tail(df)
```

Esta función es similar a `head()` así que también acepta el argumento `n` pero ahora mostrará las últimas columnas. 

Si usted desea ver los nombres de las columnas, entonces, tiene que usar la función `names()`.

```{r}
names(df)
```

Esta función también nos sirve para poder cambiar los nombres de las columnas o variables. Por ejemplo, vamos a cambiar el nombre de la variable `sexo` por `genero`.

```{r}
names(df)[2]<-"genero"
```

Usamos `names(df)` para llamar a los nombres y luego colocamos el `[2]` porque con aquello llamamos al elemento 2 del vector de nombres, el elemento 2 es `sexo`, entonces, ahora le asignamos el valor de `genero`.

Veamos ahora como ha quedado con el cambio de nombre.

```{r}
names(df)
```

Y en efecto, ahora la segunda variable que se llamaba `sexo` ahora se llama `genero`. Usted puede cambiar uno o más o todos los nombres de las variables. Veamos un ejemplo adicional para que usted pueda generalizar este conocimiento.

```{r}
names(df)[c(1:2,6)]<-c("EDAD","GENERO","EXPERIENCIA")
```

Lo que hemos hecho es cambiar el nombre de las variables de posición 1, 2 y 6. 

```{r}
names(df)
```

Ahora, si queremos saber la dimensión de nuestro data frame, es decir, el número de filas y columnas. Para obtener esta información se usa la función `dim()`.

```{r}
# Para saber el número de filas y columnas del data frame.
dim(df)
```

El resultado de posición 1 es el número de filas y el resultado de posición 2 es el número de columnas. Entonces, si deseamos saber solo el número de filas o solo el número de columnas escribiremos.

```{r}
# Para saber el número de filas.
dim(df)[1]

# Para saber el número de columnas. 
dim(df)[2]
```

## Selección de columnas. 

Para seleccionar columnas o variables vamos a usar R base y el paquete `dplyr`[^1], por cada uno veremos distintas maneras. 

### R base - por índice.

La sintaxis es similar a la que se usó para seleccionar columnas de las matrices. Recordar que una matriz tiene la siguiente estructura: `matriz[i,j]`. Donde la `i` hace referencia a las filas y la `j` hace referencia a las columnas. Lo mismo es para los data frames. 

Entonces, si deseamos seleccionar la segunda columna del data frame, entonces la sintaxis sería la siguiente:

```{r}
# Seleccionando la segunda columna.
df[,2] 
```

[^1]: Este paquete es uno de los más usados por los usuarios de R, ya que su sintaxis es muy intuitiva. Es uno de los paquetes del entorno tidyverse que contiene a otros paquetes como ggplot2, stringr, purrr, entre otros. 

Para seleccionar la columna 1, 3 y 6.

```{r}
df[,c(1,3,6)] # Selección de las columnas 1, 3 y 6.
```

###  R base - por el nombre de la variable.

Se usará la misma sintaxis que anteriormente, pero en vez de índices se colocará los nombres de las columnas.

Por ejemplo, si se quiere seleccionar la segunda columna.

```{r}
# Seleccionado la segunda columna.
df[,"GENERO"]
```

Para seleccionar las columnas 3 y 4.

```{r}
# Seleccionado la columna 3 y 4.
df[,c("ingresos","raza")]
```

### R base - usando expresiones regulares.

Podemos usar expresiones regulares, pero aún veremos ese tema en capítulos posteriores. Por el momento solo dejaremos la sintaxis y después de revisar el tema de expresiones regulares usted podrá entender al 100% la sintaxis. 

Por ejemplo, vamos a seleccionar las columnas que terminan en "a" o en "O".

```{r}
# Seleccioando las columnas que terminan en "a" o en "o".
df[,grepl("a$|O$",names(df))]
```

### Dplyr - Usando la función select.

Para usar el paquete `dplyr` primero tenemos que instalar el paquete y luego cargarlo. Para instalar el paquete usamos la siguiente sintaxis.

```{r, eval=FALSE}
# Instalando el paquete.
install.packages("dplyr")
```

Y para cargar el paquete. 

```{r, warning=FALSE, message=FALSE}
library(dplyr)
```

Una vez hecho estos pasos podemos usar las funciones de este paquete y poder seleccionar columnas con la función `select()`.

Por ejemplo, vamos a seleccionar la columna `num_hijos`.

```{r}
# Seleccionando la columna num_hijos.
df %>% select("num_hijos")
```

Para seleccionar las columnas `material_casa` y `EXPERIENCIA`.

```{r}
# Seleccionando las columnas material_casa y EXPERIENCIA.
df %>% select("material_casa","EXPERIENCIA")
```

En los dos ejemplos se ha usado el operador `%>%`, este operador es llamado `pipe`, que juega el rol de enlace entre sintaxis. Por ejemplo, en el primer ejemplo está enlazando `df` con `select("num_hijos")`, es decir, lo que se le está indicando al software es vas a seleccionar la variable `num_hijos` del data frame `df`. 

Para que usted se de cuenta, la sintaxis sin el uso del `pipe` sería el siguiente. 

```{r}
# Seleccionando la columna num_hijos.
select(df, "num_hijos")
```

El `pipe` sirve mucho para sintaxis largas ya que el código se va acortando gracias a este operador. En capítulos posteriores verá más a detalle su potencial. 

Ahora, la función `select()` también acepta otras funciones como argumentos que lo hacen más versátil. Por ejemplo, podemos usar las funciones `starts_with()` o `ends_with()` o `contains()` o `matches()`. 

Veamos ejemplos de cada uno a continuación. 

Si deseamos seleccionar columnas que empiezan con un determinado caracter o caracteres tendremos que usar la función `starts_with()`. Por ejemplo, queremos seleccionar las columnas que empiezan con la letra "E". 

```{r}
# Seleccionando las columnas que empiezan con la letra "E".
df %>% select(starts_with("E"))
```

Y en efecto se han seleccionado las columnas `EDAD` y `EXPERIENCIA`, porque las dos variables empiezan con la letra "E".

Ahora si se desea seleccionar las columnas que terminan en uno o más caracteres entonces, tendremos que usar la función `ends_with()`. Por ejemplo, vamos a seleccionar las columnas que terminan en "a".

```{r}
# Seleccionando las columnas que terminan en "a".
df %>% select(ends_with("a"))
```

Y nos selecciona las columnas `material_casa`, `raza` y `EXPERIENCIA`, ya que estas variables terminan en "a".

Si deseamos seleccionar columnas que contengan uno o más caracteres, se usará la función `contains()`. Por ejemplo queremos seleccionar las columnas que contengan los caracteres "er".

```{r}
# Seleccionando las columnas que contengan "er".
df %>% select(contains("er"))
```

Y en efecto, nos selecciona las columnas `GENERO`, `material_casa` y `EXPERIENCIA`. 

Por último, la función `matches()` sirve para seleccionar columnas usando expresiones regulares. Usaremos la misma expresión regular que en el ejemplo de R base, con lo cual seleccionaremos las columnas que terminan en "a" o en "O".

```{r}
# Seleccionando las columnas que terminan en "a" o en "O".
df %>% select(matches("a$|O$"))
```

Y en efecto, selecciona las columnas `GENERO`, `raza`, `material_casa` y `EXPERIENCIA`. Para el caso de la función select las mayúsculas y minúsculas no se diferencian a menos que se cambie uno de los argumentos el cual es `ignore.case`. Pero esto ya se verá en el tema de expresiones regulares. 

## Filtro de filas.

Al igual que anteriormente, el filtro de filas puede hacerse por medio de R base o usando el paquete `dplyr`[^2].

[^2]: Estos no son los únicos medios, en R se tiene una gran variedad, por ejemplo podemos usar el paquete `data.table` para filtrar o seleccionar columnas. Este paquete es muy bueno para grandes cantidades de datos, pero en este libro no lo veremos a profundidad.

### Usando R base. 

En R base, si deseamos llamar a una columna en específico, entonces usaremos el operador `$`[^3], es así que para llamar a una columna primero se llamará al data frame y con el `$` se llamará a la columna. Posteriormente se indicará la condición lógica para filtrar las filas y por último todo esto se asignará al data frame para que nos arroje los resultados.

[^3]: El mismo que se usa para los objetos listas.

Por ejemplo, si solo deseamos quedarnos con los individuos de género masculino, entonces usaremos la siguiente sintaxis. 

```{r}
# Quedándonos solo con los individuos de género masculino.
df[df$GENERO=="Masculino",]
```

En efecto, hemos filtrado a las filas que son del género "Masculino". Pero ¿Cómo lo hemos hecho? Primero llamamos a la columna `GENERO` con la sintaxis `df$GENERO` luego indicamos la condición lógica que nos filtre solo los de genero "Masculino", esto se logra con `df$GENERO=="Masculino"`, posteriormente colocamos esta sintaxis dentro de data frame `df` y al final colocamos la `,` a lo que nos queda `df[df$GENERO=="Masculino",]`. ¿Por qué colocamos la coma `,` al final? Porque estamos filtrando por filas, recuerde que sintaxis antes de la como significa filtrar filas y sintaxis luego de la como significa selección columnas. 

Veamos un ejemplo adicional para que quede un poco más claro. Ahora vamos a filtrar a los individuos que tienen una experiencia mayor a 5 años. 

```{r}
# Filtrando individuos que tienen una experiencia mayor a 5 años.
df[df$EXPERIENCIA>5,]
```

Si usted se da cuenta solo hemos obtenido las filas en donde la experiencia es mayor a 5 años. 

Por último, vamos a filtrar usando más de un operador lógico, por ejemplo vamos a filtrar a los individuos que son de raza negra y que el material de su casa sea de material noble.

```{r}
# Quedándonos con los individuos que son de raza negra y que el 
# material de su casa es de material noble.
df[df$raza=="negro" & df$material_casa=="noble",]
```

Y en efecto, hemos obtenido el resultado deseado. 

Con R base la sintaxis no es tan limpia, pero es muy intuitiva. Pero si queremos tener una sintaxis más limpia y a la vez intuitiva, entonces tendremos que usar el paquete `dplyr`. Pero más adelante, veremos que usando la función `subset()` de R base se logra lo mismo, pero con una sintaxis más sencilla aún, pero no tan escalable como la que se obtendría con el paquete `dplyr`.

### Dplyr - Usando la función filter.

Para filtrar por filas usando el paquete `dplyr` usaremos la función `filter()`. La sintaxis es similar al que se usó con R base, pero no es necesario usar el operador `$` ya que este paquete nos permite trabajar por etapas, es así que si primero llamamos al data frame, en las siguientes sintaxis no será necesario volver a llamarlo.

Para ver las diferencias, realizaremos los mismos ejemplos que se hicieron con R base. Entonces, primero filtraremos los que son de género "Masculino".

```{r}
# Filtrando los que son de género masculino.
df %>% filter(GENERO=="Masculino")
```

Y en efecto, obtenemos el mismo resultado. A continuación realizaremos los mismos filtros que se hicieron con R base. 

```{r}
# filtrando los que tienen experiencia mayor a 5.
df %>% filter(EXPERIENCIA>5)

# Filtrando los que son de raza negra y material de casa noble.
df %>% filter(raza=="negro" & material_casa=="noble")
```

Como se mencionó hemos usado una sintaxis similar, pero más limpia y a la vez igual de intuitiva. 

### Filtrando usando la función subset de R base. 

Pero R base no se queda atrás y tiene la función `subset()` que es igual al `filter()` del paquete `dplyr`. Veamos lo fácil de usarla. 

Vamos a desarrollar el último ejemplo que hemos visto tanto con el paquete `dplyr` y R base.

```{r}
# Filtrando los que son de raza negra y material de casa noble.
subset(df, raza=="negro" & material_casa=="noble")
```

En efecto, hemos obtenido el mismo resultado. Es un calco de la función filter, incluso es más integral, ya que la función `subset()` permite seleccionar columnas en la misma sintaxis. Vamos a ver esto en el siguiente apartado y usted elegirá cuál es la forma que más se adapta a su forma de pensar. 

## filtrando y seleccionado columnas. 

En este sección desarrollaremos ejemplos de filtrar filas y seleccionar columnas a la vez. Es así que usaremos todo lo aprendido en este capítulo y uniremos sintaxis.

Para ver las diferencias, vamos a desarrollar un único ejemplo en donde filtraremos las filas que tienen ingresos mayores a 2000, que sean de raza negra y seleccionaremos solo las columnas ingresos, raza y edad. 

Empezaremos con R base, luego con el paquete `dplyr` y por último con la función `subset()`.

```{r}
# Usando R base.
df[df$ingresos>2000 & df$raza=="negro", c("ingresos","raza","EDAD")]

# Usando el paquete dplyr.
df %>% filter(ingresos>2000 & raza=="negro") %>% select(ingresos,raza,EDAD)

# Usando la función subset.
subset(df, ingresos>2000 & raza=="negro", select=c("ingresos","raza","EDAD"))
```

En efecto, hemos obtenido los mismos resultados con las 3 sintaxis, de usted dependerá cual usar. cada una tiene sus ventajas y desventajas y dependerá del proceso que estemos haciendo y del resultado que deseamos obtener. Se recomienda usar R base a la hora de crear funciones; `dplyr`, si vamos a desarrollar más operaciones luego de filtrar y seleccionar por ejemplo, agrupar por filas, graficar, generar tablas, entre otras. Y `subset()` si y solo si lo único que haremos es filtrar y seleccionar.

Como se mencionó, esta no es la única forma de filtrar y seleccionar, estas tres formas es probable que a usted le resulten insuficientes, ya que si usted trabaja con grandes datos, lo mejor sería que usted use el paquete `data.table` o `sparklyr` u otros[^4]. R al ser un software libre y abierto tiene una gran variedad de opciones, eso es lo que lo convierte en un excepcional software ya que para cada situación usted podrá realizar una sintaxis adecuada y óptima. 

[^4]: Este es un libro introducctorio al software R en donde se muestran las sintaxis básicas y quizá hasta intermedias, por lo que escapa del tema del bigdata, que es un tema especializado, y por ende, no visto en este libro. 




